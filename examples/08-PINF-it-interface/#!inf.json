#!/usr/bin/env inf
{
    "#": "gi0.PINF.it/core/v0",

    "#": {
        "builder": "to.pinf.org.mozilla.web-ext",
        "runner": "it.pinf.org.mozilla.web-ext"
    },

    ":builder:": "builder @ builder/v0",
    ":runner:": "runner @ runner/v0",


    "gi0.PINF.it/core/v0 @ # :builder: set() manifest": {
        "permissions": [
            "webRequest",
            "<all_urls>"
        ],
        "background": {
            "scripts": [
                {
                    "uri": "bg-worker1.js",
                    "src": "../01-HelloWorld/bg-worker1.js"
                },
                {
                    "uri": "bg-worker2.js",
                    "src": "../01-HelloWorld/bg-worker2.js"
                }
            ]
        }
    },

    "gi0.PINF.it/core/v0 @ # :builder: set() routes": {
        "^/": (javascript (API) >>>

            var results = {
                "page": null,
                "bg-worker1": null,
                "bg-worker2": null
            };

            return function (req, res, next) {

                if (/^\/\.result$/.test(req.url)) {

                    var allResultsIn = false;
                    function recordResult (name, value) {

                        results[name] = value;

                        if (
                            Object.keys(results).filter(function (suite) {
                                return (!results[suite]);
                            }).length === 0 &&
                            !allResultsIn
                        ) {
                            allResultsIn = true;
                            console.log("RESULTS:", JSON.stringify(results, null, 4))

                            if (process.env.BO_TEST_FLAG_DEV) {
                                console.log("NOTE: Leaving browser open due to '--dev'.");
                            } else {
                                API.SERVER.stop();
                            }
                        }
                    }

                    recordResult(req.body.suite, req.body.result);

                    res.writeHead(200, {
                        "Content-Type": "application/json"
                    });
                    res.end('{}');
                }

                res.end(`
                    <html>
                        <body>OK!</body>
                        <script>
                            window.fetch('/.result', {
                                method: 'post',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    suite: 'page',
                                    result: 'all good'
                                })
                            });
                        </script>
                    </html>
                `);
            };
        <<<)
    },

    "gi0.PINF.it/core/v0 @ # :builder: set() postbuild": (javascript (LIB) >>>

        return async function () {

            console.log("Run postbuild.");
        };
    <<<),

    "gi0.PINF.it/core/v0 @ # :builder: write() /.~/extension.built": "",


    "gi0.PINF.it/core/v0 @ # :runner: set() extensionPath": "/.~/extension.built",

    "gi0.PINF.it/core/v0 @ # :runner: run()": ""
}